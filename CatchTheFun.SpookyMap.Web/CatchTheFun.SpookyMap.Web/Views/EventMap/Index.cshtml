@model IEnumerable<CatchTheFun.SpookyMap.Web.Models.EventLocation>
@using System.Text.Json

@{
    ViewData["Title"] = "Event Map";
    var apiKey = ViewData["GoogleMapsApiKey"];
    var highlightId = ViewData["HighlightId"]; // 전달받은 하이라이트 Id

    // JS에서 lat/lng만 다루도록 camelCase로 변환
    var dto = Model?.Select(e => new
    {
        id = e.Id,
        lat = e.Lat,
        lng = e.Lng,
        address = e.Address,
        name = e.Name,
        description = e.Description,
        somethingElse = e.SomethingElse,
        photoUrl = e.PhotoUrl,
        // TimeOnly → "HH:mm" 문자열로 변환
        startTime = e.StartTime?.ToString("HH\\:mm"),
        endTime = e.EndTime?.ToString("HH\\:mm")
    }) ?? Enumerable.Empty<object>();

    var json = JsonSerializer.Serialize(dto);
}

<!-- JSON 데이터 전달 -->
<script id="location-data" type="application/json">
    @Html.Raw(json)
</script>

@if (highlightId != null)
{
    <script>window.__HIGHLIGHT_ID__ = @highlightId;</script>
}

<!-- 지도 렌더링 JS (해시 붙여서 캐시 무효화) -->
<script src="~/js/map.js" asp-append-version="true"></script>

<h1>🎃 Event Map</h1>

<div class="row g-3">
    <div class="col-12 col-lg-10">
        <div id="map" style="height:500px"></div>
    </div>

    <div class="col-12 col-lg-2">
        <div class="card shadow-sm" style="font-size:.9rem">
            <div class="card-header" style="background-color:#241336;color:var(--spooky-text);padding:.5rem .75rem">
                <i class="bi bi-info-circle"></i> Info
            </div>

            <div class="list-group list-group-flush">
                <a class="list-group-item list-group-item-action py-2" href="https://www.waspc.org/sex-offender-information" target="_blank" rel="noopener noreferrer">
                    <i class="bi bi-search me-1"></i>
                    Registered Sex Offender Information
                    <i class="bi bi-box-arrow-up-right float-end"></i>
                </a>
                <a class="list-group-item list-group-item-action py-2" href="https://www.safekids.org/tip/halloween-safety-tips" target="_blank" rel="noopener noreferrer">
                    <i class="bi bi-lightbulb me-1"></i>
                    Halloween Safety Tips (SafeKids)
                    <i class="bi bi-box-arrow-up-right float-end"></i>
                </a>
            </div>

            <div class="card-body py-2">
                <div class="fw-semibold mb-1"><i class="bi bi-cloud-sun"></i> Weather</div>
                <div id="weather-box" class="text-muted" style="min-height:48px">
                    <div class="small">Center of map</div>
                    <div class="small">Loading...</div>
                </div>
            </div>

            <div class="card-footer text-muted" style="font-size:.8rem;padding:.4rem .75rem">
                External links. Verify local guidance.
            </div>
        </div>
    </div>
</div>

@if (apiKey == null)
{
    <p style="color: red;">⚠️ Google Maps API key is missing!</p>
}
else
{
    <!-- Google Maps + MarkerClusterer 라이브러리 -->
    <script src='@($"https://maps.googleapis.com/maps/api/js?key={apiKey}&callback=initMap&loading=async")'
            async defer></script>
}
